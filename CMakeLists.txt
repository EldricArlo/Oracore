# ==============================================================================
# CMakeLists.txt for Oracipher Core
#
# Reviewed and Updated by the Oracipher Core Code Review Committee
# Version: 2.4 (Integrated Static Analysis)
#
# This file now integrates clang-tidy directly into the build process
# to provide automated static analysis, improving code quality and
# catching potential issues early.
# ==============================================================================

# --- 1. Project Definition and C Standard ---
cmake_minimum_required(VERSION 3.12)
project(OracipherCore VERSION 1.0 LANGUAGES C)
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_C_EXTENSIONS OFF)


# --- 2. Compiler Settings and Warnings ---
set(CMAKE_POSITION_INDEPENDENT_CODE ON)
if(CMAKE_COMPILER_IS_GNUCC OR CMAKE_COMPILER_IS_CLANG)
    add_compile_options(-Wall -Wextra -Werror)
endif()

# [COMMITTEE FIX] Add platform-specific compile definitions.
if(WIN32)
    add_compile_options(-DWIN32_LEAN_AND_MEAN -DNOCRYPT)
endif()

# [COMMITTEE FIX] Integrate clang-tidy for static analysis.
find_program(CLANG_TIDY clang-tidy)
if(CLANG_TIDY)
    # Set the command to run clang-tidy for C files. The -p flag tells
    # clang-tidy where to find the compilation database (generated by CMake).
    set(CMAKE_C_CLANG_TIDY ${CLANG_TIDY} -p=${CMAKE_BINARY_DIR})
    message(STATUS "Found clang-tidy, static analysis is ENABLED.")
else()
    message(STATUS "clang-tidy not found. Static analysis will be SKIPPED.")
endif()


# --- 3. Dependency Discovery and Validation (pkg-config) ---
find_package(PkgConfig REQUIRED)
pkg_check_modules(SODIUM REQUIRED libsodium)
pkg_check_modules(OPENSSL REQUIRED openssl)
pkg_check_modules(CURL REQUIRED libcurl)

message(STATUS "Found Libsodium via pkg-config (Version: ${SODIUM_VERSION})")
message(STATUS "Found OpenSSL via pkg-config (Version: ${OPENSSL_VERSION})")
message(STATUS "Found Libcurl via pkg-config (Version: ${CURL_VERSION})")

# Enhanced Security Validation for Dependencies
if(NOT OPENSSL_VERSION VERSION_GREATER_EQUAL "3.0.0")
    message(FATAL_ERROR "
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!! BUILD FAILED: Dependency requirement not met.
!! Required OpenSSL version: >= 3.0.0
!! Detected version:       ${OPENSSL_VERSION}
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
endif()

if(NOT OPENSSL_VERSION VERSION_GREATER_EQUAL "3.0.7")
    message(WARNING "
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!! SECURITY WARNING: Your OpenSSL version (${OPENSSL_VERSION}) is older than 3.0.7
!! and may be vulnerable to CVE-2022-3786 and CVE-2022-3602.
!! It is STRONGLY recommended to upgrade your OpenSSL library.
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
endif()

if(NOT CURL_VERSION VERSION_GREATER_EQUAL "8.4.0")
    message(WARNING "
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!! SECURITY WARNING: Your Libcurl version (${CURL_VERSION}) is older than 8.4.0
!! and may be vulnerable to the SOCKS5 heap overflow (CVE-2023-38545).
!! It is STRONGLY recommended to upgrade your Libcurl library.
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
endif()

message(STATUS "Dependency version checks passed.")


# --- 4. Define the Core Shared Library (`hsc_kernel`) ---
file(GLOB_RECURSE KERNEL_SRCS
    "src/common/*.c"
    "src/core_crypto/*.c"
    "src/pki/*.c"
    "src/hsc_kernel.c"
)
add_library(hsc_kernel SHARED ${KERNEL_SRCS})

set(INTERNAL_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/src)

target_include_directories(hsc_kernel PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
    $<INSTALL_INTERFACE:include>
)
target_include_directories(hsc_kernel PRIVATE
    ${INTERNAL_INCLUDE_DIR}
    ${SODIUM_INCLUDE_DIRS}
    ${OPENSSL_INCLUDE_DIRS}
    ${CURL_INCLUDE_DIRS}
)
target_link_libraries(hsc_kernel PUBLIC
    ${SODIUM_LIBRARIES}
    ${OPENSSL_LIBRARIES}
    ${CURL_LIBRARIES}
)


# --- 5. Define Executable Targets ---
add_executable(hsc_cli src/cli.c)
target_link_libraries(hsc_cli PRIVATE hsc_kernel)

add_executable(hsc_demo src/main.c)
target_link_libraries(hsc_demo PRIVATE hsc_kernel)

add_executable(test_ca_util tests/test_ca_util.c)
target_include_directories(test_ca_util PRIVATE
    ${INTERNAL_INCLUDE_DIR}
    ${SODIUM_INCLUDE_DIRS}
    ${OPENSSL_INCLUDE_DIRS}
    ${CURL_INCLUDE_DIRS}
)
target_link_libraries(test_ca_util PRIVATE
    ${SODIUM_LIBRARIES}
    ${OPENSSL_LIBRARIES}
    ${CURL_LIBRARIES}
)


# --- 6. Define Test Suite ---
enable_testing()
include(CTest)
file(GLOB TEST_HELPER_SRCS "tests/test_helpers.c")
file(GLOB TEST_MAIN_SRCS "tests/test_*.c")
list(REMOVE_ITEM TEST_MAIN_SRCS
    "${CMAKE_CURRENT_SOURCE_DIR}/tests/test_helpers.c"
    "${CMAKE_CURRENT_SOURCE_DIR}/tests/test_ca_util.c"
)

foreach(test_source ${TEST_MAIN_SRCS})
    get_filename_component(test_name ${test_source} NAME_WE)
    add_executable(${test_name} ${test_source} ${TEST_HELPER_SRCS})
    
    target_include_directories(${test_name} PRIVATE ${INTERNAL_INCLUDE_DIR})
    
    target_link_libraries(${test_name} PRIVATE hsc_kernel)
    
    add_test(NAME ${test_name} COMMAND ${test_name})
    set_tests_properties(${test_name} PROPERTIES
        ENVIRONMENT "HSC_PEPPER_HEX=00112233445566778899aabbccddeeff00112233445566778899aabbccddeeff"
    )
endforeach()


# --- 7. Installation and RPATH Rules ---
message(STATUS "Configuring installation rules...")
set(CMAKE_BUILD_WITH_INSTALL_RPATH TRUE)
set(CMAKE_INSTALL_RPATH "$ORIGIN")
if(APPLE)
  set(CMAKE_INSTALL_RPATH "@loader_path")
endif()

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

install(TARGETS hsc_kernel hsc_cli hsc_demo test_ca_util
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
)
install(FILES include/hsc_kernel.h DESTINATION include)


# --- 8. Optional Developer Tools Integration ---
find_program(CLANG_FORMAT clang-format)
if(CLANG_FORMAT)
    message(STATUS "Found clang-format: ${CLANG_FORMAT}")
    file(GLOB_RECURSE ALL_CODE_FILES
        "src/*.c" "src/*.h" "include/*.h" "tests/*.c" "tests/*.h"
    )
    add_custom_target(format
        COMMAND ${CLANG_FORMAT} -i ${ALL_CODE_FILES}
        COMMENT "Formatting all source and header files with clang-format..."
    )
else()
    message(STATUS "clang-format not found. The 'format' target will not be available.")
endif()


message(STATUS "CMake configuration complete. You can now build with 'cmake --build .'")
message(STATUS "Run tests with 'ctest'.")
message(STATUS "Run code formatter with 'cmake --build . --target format'.")